// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(MAHASISWA)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mahasiswa Mahasiswa?
  dosen     Dosen?
}

model Mahasiswa {
  id            String         @id @default(cuid())
  nim           String         @unique
  nama          String
  angkatan      Int
  user          User           @relation(fields: [userId], references: [id])
  userId        String         @unique
  programStudi  ProgramStudi   @relation(fields: [programStudiId], references: [id])
  programStudiId String
  krs           KRS[]
  tagihan       Tagihan[]
  notifications Notification[]
}

model Dosen {
  id            String       @id @default(cuid())
  nidn          String       @unique
  nama          String
  user          User         @relation(fields: [userId], references: [id])
  userId        String       @unique
  programStudi  ProgramStudi @relation(fields: [programStudiId], references: [id])
  programStudiId String
  kelas         Kelas[]
}

model Fakultas {
  id           String         @id @default(cuid())
  kode         String         @unique
  nama         String
  programStudi ProgramStudi[]
}

model ProgramStudi {
  id        String      @id @default(cuid())
  kode      String      @unique
  nama      String
  fakultas  Fakultas    @relation(fields: [fakultasId], references: [id])
  fakultasId String
  mahasiswa Mahasiswa[]
  dosen     Dosen[]
}

model MataKuliah {
  id          String       @id @default(cuid())
  kode        String       @unique
  nama        String
  sks         Int
  semester    Int
  prasyarat   PrasyaratMk[] @relation("Prasyarat")
  prasyaratUntuk PrasyaratMk[] @relation("PrasyaratUntuk")
  kelas       Kelas[]
}

model PrasyaratMk {
  id             String     @id @default(cuid())
  mataKuliah     MataKuliah @relation("Prasyarat", fields: [mataKuliahId], references: [id])
  mataKuliahId   String
  prasyarat      MataKuliah @relation("PrasyaratUntuk", fields: [prasyaratId], references: [id])
  prasyaratId    String

  @@unique([mataKuliahId, prasyaratId])
}

model Kelas {
  id           String   @id @default(cuid())
  kode         String   @unique
  kuota        Int
  terisi       Int      @default(0)
  hari         String
  jamMulai     String
  jamSelesai   String
  ruangan      String
  dosen        Dosen    @relation(fields: [dosenId], references: [id])
  dosenId      String
  mataKuliah   MataKuliah @relation(fields: [mataKuliahId], references: [id])
  mataKuliahId String
  periode      PeriodeAkademik @relation(fields: [periodeId], references: [id])
  periodeId    String
  krs          KRS[]
}

model KRS {
  id          String      @id @default(cuid())
  mahasiswa   Mahasiswa   @relation(fields: [mahasiswaId], references: [id])
  mahasiswaId String
  kelas       Kelas       @relation(fields: [kelasId], references: [id])
  kelasId     String
  status      KRSStatus   @default(DRAFT)
  nilai       Nilai?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Nilai {
  id         String   @id @default(cuid())
  nilaiAngka Float
  nilaiHuruf String
  krs        KRS      @relation(fields: [krsId], references: [id])
  krsId      String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model PeriodeAkademik {
  id           String   @id @default(cuid())
  kode         String   @unique
  nama         String
  tanggalMulai DateTime
  tanggalSelesai DateTime
  isActive     Boolean  @default(false)
  kelas        Kelas[]
}

model Tagihan {
  id                String            @id @default(cuid())
  mahasiswa         Mahasiswa         @relation(fields: [mahasiswaId], references: [id])
  mahasiswaId       String
  jenisPembayaran   JenisPembayaran   @relation(fields: [jenisPembayaranId], references: [id])
  jenisPembayaranId String
  jumlah            Float
  tanggalJatuhTempo DateTime
  status            PembayaranStatus  @default(UNPAID)
  buktiPembayaran   BuktiPembayaran[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model JenisPembayaran {
  id      String    @id @default(cuid())
  kode    String    @unique
  nama    String
  tagihan Tagihan[]
}

model BuktiPembayaran {
  id        String   @id @default(cuid())
  tagihan   Tagihan  @relation(fields: [tagihanId], references: [id])
  tagihanId String
  filePath  String
  uploadedAt DateTime @default(now())
}

model Notification {
  id        String    @id @default(cuid())
  user      Mahasiswa @relation(fields: [userId], references: [id])
  userId    String
  message   String
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  actor     String
  action    String
  target    String
  timestamp DateTime @default(now())
}

enum Role {
  ADMIN
  DOSEN
  MAHASISWA
}

enum KRSStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum PembayaranStatus {
  UNPAID
  PAID
  VERIFIED
}
